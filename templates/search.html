<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–∏—Å–∫ NFT</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <nav class="navbar">
            <div class="nav-brand">üéÅ NFT Gifts</div>
            <div class="nav-links">
                <a href="/" class="nav-link">üè† –ì–ª–∞–≤–Ω–∞—è</a>
                <a href="/search" class="nav-link active">üîç –ü–æ–∏—Å–∫</a>
            </div>
        </nav>

        <!-- –ü–æ–∏—Å–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="search-panel">
            <div class="search-row">
                <select id="source-select" class="source-select">
                    {% for source in sources %}
                    <option value="{{ source.name }}">{{ source.name }}</option>
                    {% endfor %}
                </select>

                <select id="field-select" class="field-select">
                    <option value="all">–í—Å–µ –ø–æ–ª—è</option>
                    <option value="model">–ú–æ–¥–µ–ª—å</option>
                    <option value="owner">–í–ª–∞–¥–µ–ª–µ—Ü</option>
                    <option value="symbol">–°–∏–º–≤–æ–ª</option>
                    <option value="backdrop">–§–æ–Ω</option>
                    <option value="num">–ù–æ–º–µ—Ä (—Ç–æ—á–Ω—ã–π)</option>
                </select>
            </div>

            <div class="search-box">
                <input 
                    type="text" 
                    id="search-input" 
                    class="search-input" 
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞..."
                    autocomplete="off"
                    list="search-suggestions"
                >
                <datalist id="search-suggestions"></datalist>
                <div id="suggestions" class="suggestions-list"></div>  <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ -->
                <button id="search-button" class="search-button">üîç –ù–∞–π—Ç–∏</button>
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
        <div class="search-results">
            <div class="results-header" id="results-header" style="display: none;">
                –ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: <span id="results-count">0</span>
            </div>

            <div class="nft-grid" id="nft-grid">
                <div class="search-placeholder">
                    <div class="placeholder-icon">üîç</div>
                    <p>–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ NFT</p>
                    <small>–ú–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å –ø–æ –º–æ–¥–µ–ª–∏, –≤–ª–∞–¥–µ–ª—å—Ü—É, —Å–∏–º–≤–æ–ª—É –∏–ª–∏ –Ω–æ–º–µ—Ä—É</small>
                </div>
            </div>
        </div>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>–ü–æ–∏—Å–∫...</p>
        </div>
    </div>

    <script>
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const sourceSelect = document.getElementById('source-select');
        const fieldSelect = document.getElementById('field-select');
        const nftGrid = document.getElementById('nft-grid');
        const loading = document.getElementById('loading');
        const resultsHeader = document.getElementById('results-header');
        const resultsCount = document.getElementById('results-count');

        // –ü–æ–∏—Å–∫ —Å —Ç–æ—á–Ω—ã–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º
        async function performSearchExact(query) {
            const source = sourceSelect.value;
            const field = fieldSelect.value;

            loading.style.display = 'flex';
            nftGrid.innerHTML = '';
            resultsHeader.style.display = 'none';

            try {
                const response = await fetch(`/api/search/${source}?query=${encodeURIComponent(query)}&field=${field}&exact=true`);
                const result = await response.json();

                loading.style.display = 'none';

                if (result.success) {
                    displayResults(result.data);
                } else {
                    nftGrid.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${result.error}</div>`;
                }
            } catch (error) {
                loading.style.display = 'none';
                nftGrid.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞</div>';
                console.error('Search error:', error);
            }
        }

        // –û–±—ã—á–Ω—ã–π –ø–æ–∏—Å–∫ (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–µ–∂–Ω–∏–º)
        async function performSearch() {
            const query = searchInput.value.trim();
            if (!query) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞');
                return;
            }

            const source = sourceSelect.value;
            const field = fieldSelect.value;

            loading.style.display = 'flex';
            nftGrid.innerHTML = '';
            resultsHeader.style.display = 'none';

            try {
                const response = await fetch(`/api/search/${source}?query=${encodeURIComponent(query)}&field=${field}`);
                const result = await response.json();

                loading.style.display = 'none';

                if (result.success) {
                    displayResults(result.data);
                } else {
                    nftGrid.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${result.error}</div>`;
                }
            } catch (error) {
                loading.style.display = 'none';
                nftGrid.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞</div>';
                console.error('Search error:', error);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function displayResults(nfts) {
            resultsHeader.style.display = 'block';
            resultsCount.textContent = nfts.length;

            if (nfts.length === 0) {
                nftGrid.innerHTML = `
                    <div class="search-placeholder">
                        <div class="placeholder-icon">üòî</div>
                        <p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                        <small>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</small>
                    </div>
                `;
                return;
            }

            nftGrid.innerHTML = nfts.map(nft => `
                <div class="nft-card" style="background: linear-gradient(135deg, ${getGradientColors(nft.backdrop)})">
                    <div class="nft-header">
                        <span class="nft-num">#${nft.num}</span>
                        <span class="nft-symbol">${nft.symbol || 'N/A'}</span>
                    </div>
                    <div class="nft-body">
                        <div class="nft-model">${nft.model || 'Unknown'}</div>
                        <div class="nft-info">
                            <div class="nft-info-item">
                                <span class="label">–í–ª–∞–¥–µ–ª–µ—Ü:</span>
                                <span class="value">${nft.owner || 'Anonymous'}</span>
                            </div>
                            <div class="nft-info-item">
                                <span class="label">–§–æ–Ω:</span>
                                <span class="value">${nft.backdrop || 'Default'}</span>
                            </div>
                            <div class="nft-info-item">
                                <span class="label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span>
                                <span class="value">${nft.quantity || 0}</span>
                            </div>
                        </div>
                    </div>
                    <a href="${nft.url}" target="_blank" class="nft-button">
                        –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
                    </a>
                </div>
            `).join('');
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞
        function getGradientColors(backdrop) {
            const gradients = {
                'Gold': '#FFD700, #FF8C00',
                'Silver': '#C0C0C0, #808080',
                'Bronze': '#CD7F32, #8B4513',
                'Blue': '#4169E1, #1E90FF',
                'Red': '#DC143C, #8B0000',
                'Green': '#32CD32, #006400',
                'Purple': '#9370DB, #4B0082',
                'Pink': '#FF69B4, #FF1493',
                'default': '#667eea, #764ba2'
            };
            return gradients[backdrop] || gradients['default'];
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        searchButton.addEventListener('click', performSearch);
        
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª–µ–π model –∏ symbol (–æ–±–Ω–æ–≤–ª–µ–Ω–æ)
        let autocompleteTimeout;
        searchInput.addEventListener('input', async (e) => {
            const query = e.target.value.trim();
            const field = fieldSelect.value;
            const source = sourceSelect.value;
            
            // –¢–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª–µ–π model –∏ symbol –∏ –±–æ–ª—å—à–µ 3 —Å–∏–º–≤–æ–ª–æ–≤
            if (field !== 'model' && field !== 'symbol' || query.length <= 3) {
                document.getElementById('search-suggestions').innerHTML = '';
                return;
            }
            
            clearTimeout(autocompleteTimeout);
            autocompleteTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/autocomplete/${source}/${field}?query=${encodeURIComponent(query)}`);
                    const result = await response.json();
                    
                    if (result.success && result.data.length > 0) {
                        const datalist = document.getElementById('search-suggestions');
                        datalist.innerHTML = result.data.map(item => `<option value="${item}">`).join('');
                    }
                } catch (error) {
                    console.error('Autocomplete error:', error);
                }
            }, 300);
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ placeholder –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª—è –ø–æ–∏—Å–∫–∞
        fieldSelect.addEventListener('change', (e) => {
            const placeholders = {
                'all': '–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞...',
                'model': '–í–≤–µ–¥–∏—Ç–µ –º–æ–¥–µ–ª—å –¥–ª—è –ø–æ–∏—Å–∫–∞...',
                'owner': '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –≤–ª–∞–¥–µ–ª—å—Ü–∞...',
                'symbol': '–í–≤–µ–¥–∏—Ç–µ —Å–∏–º–≤–æ–ª –¥–ª—è –ø–æ–∏—Å–∫–∞...',
                'backdrop': '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–æ–Ω–∞...',
                'num': '–í–≤–µ–¥–∏—Ç–µ —Ç–æ—á–Ω—ã–π –Ω–æ–º–µ—Ä –ø–æ–¥–∞—Ä–∫–∞...'
            };
            searchInput.placeholder = placeholders[e.target.value] || '–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞...';
            document.getElementById('search-suggestions').innerHTML = '';
        });
        let debounceTimer;
        document.getElementById('search-input').addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const query = this.value;
                if (query.length > 3) {  // –ò–∑–º–µ–Ω–µ–Ω–æ: —Ç–µ–ø–µ—Ä—å —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–æ–ª—å—à–µ 3 —Å–∏–º–≤–æ–ª–æ–≤
                    fetch(`/get_autocomplete_data?query=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            const suggestions = document.getElementById('suggestions');
                            suggestions.innerHTML = '';
                            data.suggestions.forEach(sugg => {
                                const div = document.createElement('div');
                                div.textContent = sugg.value;
                                div.onclick = () => {
                                    document.getElementById('search-input').value = sugg.value;
                                    suggestions.innerHTML = '';
                                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å —Ç–æ—á–Ω—ã–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º
                                    performSearchExact(sugg.value);
                                };
                                suggestions.appendChild(div);
                            });
                        });
                } else {
                    document.getElementById('suggestions').innerHTML = '';
                }
            }, 300);  // Debounce 300ms
        });
    </script>
</body>
</html>
